# F-020: Soul Audit: Consent gate

## Metadata

- Feature ID: F-020
- Category: Soul Audit
- Owner: Engineering + Product
- Status: done
- Slug: soul-audit-consent-gate

## Scores

- Baseline Score: 5/10
- Engineering Score: 7/10
- Founder Score: 0/10
- Founder 10/10 Rule: only founder can assign 10/10

## User Expectation

- Consent gate

## 10/10 Definition

- Behavior is reliable, predictable, and validated on desktop and mobile.
- Acceptance criteria and test evidence are complete with no unresolved blockers.

## Methodology References

- M00
- M02
- M03
- M06

## Device Contracts

### Desktop

- Primary interaction path is discoverable in one clear route.
- Error and recovery states are visible and actionable.

### Mobile

- Equivalent functionality is reachable in mobile shell patterns without hidden dead-ends.
- Touch targets and readability remain usable at 375/390 widths.

## Scope

### In scope

- Feature behavior and UX quality for: Consent gate
- Tracking and regression prevention for this feature

### Out of scope

- Unrelated feature changes not mapped to F-020

## Interfaces Touched

- `src/app/soul-audit/results/page.tsx`
- `src/app/api/soul-audit/consent/route.ts`
- `src/app/api/soul-audit/select/route.ts`
- `src/components/CookieConsentBanner.tsx`
- `src/components/ConsentAwareAnalytics.tsx`
- `src/lib/site-consent.ts`
- `src/app/providers.tsx`
- `src/app/layout.tsx`
- `__tests__/soul-audit-flow.test.ts`
- `__tests__/soul-audit-edge-cases.test.ts`
- `__tests__/soul-audit-consent-gate-contract.test.ts`
- `__tests__/site-consent.test.ts`

## Dependencies

- F-019
- F-021
- F-024

## Acceptance Criteria

- [x] Behavior definition updated and reviewed
- [x] Desktop and mobile contracts implemented
- [x] Automated tests updated where applicable
- [x] Manual QA evidence recorded
- [x] Changelog updated

## Test Matrix

- [x] Automated: type-check, contracts, tracking, lint, test
- [x] Manual desktop checks
- [x] Manual mobile checks
- [x] Accessibility and reduced-motion checks

## Risks and Rollback

- Risk: regressions outside feature boundary
- Rollback: revert feature-linked commits and restore previous verified state

## Incremental Outcomes Log

| Date       | Commit  | Decision IDs   | Feature ID | Change Summary                                                                                                                                                                                                                                                                                                                           | Verification                                       | Score Delta | Residual Gaps                                                                                              |
| ---------- | ------- | -------------- | ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------- | ----------- | ---------------------------------------------------------------------------------------------------------- |
| 2026-02-18 | pending | SA-003, SA-004 | F-020      | Implemented explicit consent-recording state in Soul Audit results: consent must be recorded before options unlock, changing consent choices invalidates prior consent-token state, and consent status messages now guide recovery. Added richer consent/select API error details for required actions.                                  | `lint`, `type-check`, `test`, `verify:*`           | 5 -> 7      | Manual physical-device UX polish for consent copy hierarchy still required.                                |
| 2026-02-19 | pending | SA-003, SA-004 | F-020      | Moved consent interaction to site entry with a global cookie notice (`essential only` / `accept all`) persisted in cookies, removed consent checkboxes from Soul Audit results, and kept option unlock focused on crisis acknowledgement only when required. Added consent-aware analytics mounting and cookie helper tests.             | `lint`, `type-check`, targeted tests               | 7 -> 8      | Live Safari + mobile device QA pass still required for consent banner timing and sticky-shell coexistence. |
| 2026-02-20 | pending | SA-003, SA-004 | F-020      | Fixed Soul Audit option click perceived no-op at the root consent gate: missing site consent now triggers a dedicated required-consent browser event, forces cookie-banner visibility/focus with temporary attention styling, and renders an inline actionable error directly above option cards while keeping strict blocking behavior. | `type-check`, `eslint`, `prettier`, targeted tests | 8 -> 8.5    | Complete live Safari + mobile browser validation for banner attention timing and inline error visibility.  |

## Next Increment

- [ ] Add browser E2E coverage for first-visit cookie notice and Soul Audit option selection continuity.
- [ ] Capture manual Safari + mobile screenshots for cookie notice entry timing and dismissal behavior.
