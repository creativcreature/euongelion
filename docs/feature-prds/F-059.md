# F-059: Create Missing Soul Audit Supabase Tables

**Status:** Implemented
**Priority:** Critical (cascade generation completely broken — 0 of 7 days forever)

---

## Problem

The Soul Audit cascade day generation (`/api/soul-audit/generate-next`) returned "Plan not found" for every request, causing all 7 days to stay in "BUILDING" state indefinitely. Users waited 30+ minutes seeing 0/7 days ready.

## Root Cause

The Soul Audit tables were never created in Supabase. The database migrations (001-008) cover the original series/devotionals/bookmarks schema, but none of the tables required by the Soul Audit flow:

- `audit_runs`
- `audit_options`
- `audit_option_telemetry`
- `consent_records`
- `audit_selections`
- `devotional_plan_instances`
- `devotional_plan_days`
- `devotional_day_citations`
- `mock_account_sessions`
- `annotations`

The `safeInsert()` and `safeUpsert()` functions in `repository.ts` silently swallowed ALL errors with `catch { // no-op }`, so these failures were invisible in logs. Data only existed in the serverless function's in-memory store for the duration of that single invocation.

### Why selection appeared to work

The submit and select endpoints happened to run in the same (or warm) Vercel instance, so in-memory data persisted across those requests. The select response included plan data that the client stored in sessionStorage. But when `generate-next` ran in a different instance, it had empty memory and nothing in Supabase.

## Fix

1. **Migration 009**: Creates all missing tables with proper indices, foreign keys, and RLS.
2. **Error logging**: Replaced silent `catch { // no-op }` in `safeInsert`/`safeUpsert` with `console.error` logging so failures appear in Vercel function logs.
3. **Client-side context fallback** (F-059b): `generate-next` now accepts `planOutline`, `optionMeta`, `userResponse`, and `currentDays` in the request body. When Supabase lookups return null, the server falls back to this client-supplied context. The client cascade (`results/page.tsx`) reads fresh from sessionStorage/localStorage each call to avoid stale React closures.
4. **Cascade survival** (F-059c): The cascade died before reaching generate-next because `generation-status` returned 404 and the cascade exited on `if (!initialStatus) return`. Fixed: cascade builds synthetic status from localStorage planDays when the API fails. Also fixed `generation-status` to return "generating" instead of 404.

## Deployment

The migration should be run in the Supabase SQL editor for full persistence:

```
database/migrations/009_create_soul_audit_tables.sql
```

However, with the F-059b client-side fallback, cascade generation works even **before** the migration is run — data flows from client sessionStorage through the request body.

## Files Changed

- `database/migrations/009_create_soul_audit_tables.sql` (new)
- `src/lib/soul-audit/repository.ts` (error logging)
- `src/app/api/soul-audit/generate-next/route.ts` (client context fallback)
- `src/app/soul-audit/results/page.tsx` (send plan context in cascade)
- `docs/feature-prds/F-059.md` (this file)

## Verification

After running the migration:

1. Start a new Soul Audit
2. Select an `ai_generative` option
3. Days should progress from "BUILDING" to complete (1 by 1, ~15-20s each)
4. Each completed day should contain real RAG references in endnotes
