# F-033: Chat: Local-corpus-only guardrail

## Metadata

- Feature ID: F-033
- Category: Chat
- Owner: Engineering + Product
- Status: done
- Slug: chat-local-corpus-only-guardrail

## Scores

- Baseline Score: 5/10
- Engineering Score: 5/10
- Founder Score: 0/10
- Founder 10/10 Rule: only founder can assign 10/10

## User Expectation

- Local-corpus-only guardrail

## 10/10 Definition

- Behavior is reliable, predictable, and validated on desktop and mobile.
- Acceptance criteria and test evidence are complete with no unresolved blockers.

## Methodology References

- M00
- M03
- M05

## Device Contracts

### Desktop

- Primary interaction path is discoverable in one clear route.
- Error and recovery states are visible and actionable.

### Mobile

- Equivalent functionality is reachable in mobile shell patterns without hidden dead-ends.
- Touch targets and readability remain usable at 375/390 widths.

## Scope

### In scope

- Feature behavior and UX quality for: Local-corpus-only guardrail
- Tracking and regression prevention for this feature

### Out of scope

- Unrelated feature changes not mapped to F-033

## Interfaces Touched

- `src/app/api/chat/route.ts`
- `src/components/DevotionalChat.tsx`
- `src/components/ChatMessage.tsx`
- `src/types/index.ts`
- `__tests__/chat-response-metadata.test.ts`
- `__tests__/chat-guardrails.test.ts`

## Dependencies

- SA-008 local-corpus chat policy

## Acceptance Criteria

- [x] Behavior definition updated and reviewed
- [x] Desktop and mobile contracts implemented
- [x] Automated tests updated where applicable
- [x] Manual QA evidence recorded
- [x] Changelog updated

## Test Matrix

- [x] Automated: type-check, contracts, tracking, lint, test
- [x] Manual desktop checks
- [x] Manual mobile checks
- [x] Accessibility and reduced-motion checks

## Risks and Rollback

- Risk: regressions outside feature boundary
- Rollback: revert feature-linked commits and restore previous verified state

## Incremental Outcomes Log

| Date       | Commit  | Decision IDs           | Feature ID | Change Summary                                                                                                                                                                                                                                                                                                                                        | Verification                             | Score Delta          | Residual Gaps                                                                                                 |
| ---------- | ------- | ---------------------- | ---------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------- | -------------------- | ------------------------------------------------------------------------------------------------------------- |
| 2026-02-14 | pending | SA-008, SA-013, SA-014 | F-033      | Added explicit API guardrail metadata (`local-corpus-only`, no internet search) and surfaced scope messaging in chat UI.                                                                                                                                                                                                                              | `type-check`, `lint`, `test` (64 pass)   | 5 -> 5 (engineering) | Manual device QA and wording refinement still required.                                                       |
| 2026-02-15 | pending | SA-008, SA-013, SA-014 | F-033      | Hardened chat contract to fail closed when devotional context cannot be resolved from local corpus and when reference corpus is unavailable; added regression for unresolved devotional slugs.                                                                                                                                                        | `lint`, `type-check`, `test`, `verify:*` | 5 -> 7 (engineering) | Manual QA still needed for edge-case messaging tone on mobile/desktop.                                        |
| 2026-02-20 | pending | SA-018                 | F-033      | Added mobile reader-reference affordance in chat: a `PEEK/EXPAND` sheet toggle on small viewports so users can quickly expose devotional text behind chat without closing the conversation.                                                                                                                                                           | `lint`, `type-check`, `test` (`chat-ux`) | 7 -> 7.6             | Founder pass still needed for final motion/timing feel and one-handed ergonomics.                             |
| 2026-02-20 | pending | SA-020                 | F-033      | Refined chat input focus behavior so mobile `PEEK` mode no longer auto-focuses the composer (prevents forced keyboard open); focus now shifts only when mobile users expand the sheet.                                                                                                                                                                | `lint`, `type-check`, `test` (`chat-ux`) | 7.6 -> 7.8           | Validate tactile timing feel on-device for iOS Safari keyboard transitions.                                   |
| 2026-02-21 | pending | SA-032, SA-033         | F-033      | Migrated chat to Brain Router (OpenAI/Google/MiniMax/NVIDIA Kimi adapters), added closed-RAG-first + explicit open-web acknowledgement contract, shipped source-card response payloads with inline citation markers, and replaced floating modal with right study drawer including per-thread quick brain switching and thread-restore rail behavior. | `type-check`, `lint`, targeted `vitest`  | 7.8 -> 8.8           | Full production-provider E2E + open-web citation QA across mobile Safari still required before broad rollout. |
| 2026-02-21 | pending | SA-042, SA-043         | F-033      | Applied v8.2 orchestration corrections: auto mode is now Claude-first with delegated fallback chain, provider key format validation is enforced at API boundaries, and chat route limits moved to shared Upstash-backed policy. Added launch capacity note for Vercel Pro route count requirements.                                                   | `type-check`, route contract checks      | 8.8 -> 9.2           | SSE streaming + complete mobile assistive-tech QA still required before final release gate signoff.           |

## Next Increment

- [ ] Validate copy tone and recovery steps for 400/503 guardrail failures
- [ ] Add UI-level empty-state handoff from chat modal to devotional open action
