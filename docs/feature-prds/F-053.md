# F-053: Generative 80/20 RAG Composition Engine

**Category:** Devotional Engine
**Decision IDs:** SA-020, SA-021, SA-022
**Status:** Done
**Baseline:** 0/10

## Summary

Replaces the curated-first matching system with a fully generative devotional engine. Instead of matching users to 32 pre-built series, the system generates unique 7-day devotional plans on the fly where 80% of content comes from the 13GB reference library via RAG retrieval and 20% is AI-generated bridging/personalization.

## Requirements

1. **Generative plan outlines**: Submit route generates 3 unique plan outlines via LLM instead of matching to curated series. Each outline approaches the topic from a different angle.
2. **7-day plan structure**: 5 devotional days (chiastic arc A-B-C-B'-A') + Day 6 sabbath/review + Day 7 next-week discernment.
3. **80/20 RAG composition**: 80% content from reference library (commentaries, lexicons, theology) via chunked retrieval, 20% AI-generated structural bridges and personalization.
4. **PaRDeS + chiastic structure**: Each day assigned a PaRDeS level (peshat/remez/derash/sod/integrated) and chiastic position. Internal structure, not user-facing labels.
5. **Contextual module selection**: 12 module types are a palette (3-10 per day), not a checklist. LLM selects modules based on topic, chiastic position, and length. Always includes scripture + reflection/prayer.
6. **Progressive day delivery**: Day 1 generated synchronously at selection time. Days 2-7 generated via cascading client-triggered calls to `/api/soul-audit/generate-next`.
7. **Composition transparency**: Each generated day includes a composition report showing reference vs generated percentages and source list.
8. **Graceful fallback**: If generative path fails (LLM error, reference library absent), system falls back to curated-first matching.
9. **Option kind**: New `ai_generative` kind alongside existing `ai_primary` and `curated_prefab`. 3 AI options (generative or primary) + 2 curated prefab = 5 total.

## New Files

- `src/lib/soul-audit/reference-retriever.ts` -- chunked corpus builder + two-pass keyword retrieval
- `src/lib/soul-audit/outline-generator.ts` -- generates 3 plan outlines via LLM
- `src/lib/soul-audit/generative-builder.ts` -- 80/20 RAG day generation (devotional, sabbath, review)
- `src/app/api/soul-audit/generate-next/route.ts` -- cascading day generation endpoint
- `src/app/api/soul-audit/generation-status/route.ts` -- progressive delivery poll endpoint

## Modified Files

- `src/types/soul-audit.ts` -- new types for generative engine
- `src/types/database.ts` -- ai_generative kind
- `src/app/api/soul-audit/submit/route.ts` -- generative outline path with curated fallback
- `src/app/api/soul-audit/select/route.ts` -- ai_generative handler with Day 1 sync generation
- `src/app/soul-audit/results/page.tsx` -- progressive generation UX, module rendering
- `src/lib/soul-audit/matching.ts` -- exported utility functions for generative path
- `src/lib/soul-audit/repository.ts` -- telemetry strategy type update

## Acceptance Criteria

- [ ] "I want to learn about the prophets" produces plans about prophets (not random series)
- [ ] Each generated day has composition report showing ~80% reference material
- [ ] Day 6 is sabbath/review, Day 7 is next-week discernment
- [ ] Module selection varies across days (3-10 modules, not always 12)
- [ ] Day 1 renders immediately after selection; Days 2-7 build progressively
- [ ] Curated prefab options still route to series page
- [ ] If LLM fails, curated-matching fallback activates
- [ ] Type-check, lint, and build pass clean

## Methodology References

- M00

### Desktop

- Results page: progressive generation progress bar visible above day content
- Module rendering: each module block rendered as a distinct typographic section with heading
- Composition report: inline reference/generated percentage display below day content
- Day strip: 7-day horizontal rail with BUILDING/FAILED status indicators

### Mobile

- Results page: same progressive generation UX, progress bar full-width at 375px
- Module rendering: single-column module blocks, full-width at mobile breakpoints
- Day strip: horizontally scrollable 7-day rail with touch targets >= 44px
- Skeleton loading: animated pulse bars for pending days

## Outcomes Log

| Date       | Event                                         |
| ---------- | --------------------------------------------- |
| 2026-02-23 | Initial implementation: all 6 phases complete |
