# F-054: Token-Saving Strategy for Generative Devotionals

**Status:** Implemented
**Decision ID:** SA-021
**Priority:** High (cost governance)

---

## Problem

Each complete 7-day generative devotional plan requires 8-13 LLM API calls, totaling ~$0.0076 per plan on OpenAI's cheapest tier. At the $100/month platform budget, this caps capacity at ~13,100 plans/month. Several of these calls are redundant or could be replaced with deterministic builders at comparable quality.

## Strategy Summary

Six optimizations across three tiers, controlled by feature flags for premium/free toggling:

| Optimization                 | Savings                  | Flag                           | Default                 |
| ---------------------------- | ------------------------ | ------------------------------ | ----------------------- |
| Deterministic Sabbath/Review | 2 LLM calls eliminated   | `GENERATIVE_SABBATH_REVIEW`    | `false` (deterministic) |
| Deterministic intent parsing | 1 LLM call eliminated    | `LLM_INTENT_PARSING`           | `false` (deterministic) |
| Skip doc reranking           | 1 LLM call eliminated    | `LLM_DOC_RERANKING`            | `false` (keyword order) |
| Outline response cache       | ~50-80% of outline calls | `OUTLINE_CACHE_ENABLED`        | `true`                  |
| Compressed system prompts    | ~40% fewer prompt tokens | Always on                      | N/A                     |
| Reduced reference chunks     | ~30% fewer input tokens  | `MAX_REFERENCE_CHUNKS_PER_DAY` | `4`                     |

## Cost Impact

### Before (per plan, OpenAI tier)

| Call                | Count | Cost          |
| ------------------- | ----- | ------------- |
| Intent Parse (LLM)  | 1     | $0.000128     |
| Outline Generation  | 1     | $0.001100     |
| Days 1-5 Generation | 5     | $0.005375     |
| Sabbath (LLM)       | 1     | $0.000475     |
| Review (LLM)        | 1     | $0.000555     |
| **Total**           | **9** | **$0.007633** |

### After (per plan, no cache hits)

| Call                                | Count | Cost          |
| ----------------------------------- | ----- | ------------- |
| Intent Parse (deterministic)        | 0     | $0.000000     |
| Outline Generation (compressed)     | 1     | $0.000880     |
| Days 1-5 (fewer chunks, compressed) | 5     | $0.004300     |
| Sabbath (deterministic)             | 0     | $0.000000     |
| Review (deterministic)              | 0     | $0.000000     |
| **Total**                           | **6** | **$0.005180** |

### Savings: **32% cost reduction per plan**

| Metric               | Before   | After   | With 50% Cache           |
| -------------------- | -------- | ------- | ------------------------ |
| Cost per plan        | $0.0076  | $0.0052 | $0.0047                  |
| LLM calls per plan   | 9        | 6       | 6 (but 50% skip outline) |
| Plans per $100/month | ~13,100  | ~19,200 | ~21,300                  |
| Capacity increase    | baseline | +47%    | +63%                     |

## Feature Flags

All flags are environment variables with cost-optimized defaults:

```env
# Set to true for premium quality (costs more)
GENERATIVE_SABBATH_REVIEW=false
LLM_INTENT_PARSING=false
LLM_DOC_RERANKING=false

# Cache (recommended: always on)
OUTLINE_CACHE_ENABLED=true

# Tuning
MAX_REFERENCE_CHUNKS_PER_DAY=4
MAX_CHUNK_CHARS_IN_CONTEXT=1200
```

## Implementation Details

### 1. Deterministic Sabbath/Review

- Sabbath (Day 6) and Review (Day 7) explicitly specify "no new teaching"
- `buildFallbackSabbath()` and `buildFallbackReview()` already produce quality content
- Now exported and used by default in `generate-next/route.ts`
- LLM versions preserved behind `GENERATIVE_SABBATH_REVIEW=true` flag

### 2. Deterministic Intent Parsing

- `parseAuditIntent()` (keyword-based) is the free fallback
- LLM intent adds ~$0.000128 but the outline LLM already sees raw user text
- Marginal quality improvement doesn't justify the cost at scale

### 3. Outline Response Cache

- In-memory LRU cache (200 entries, 1-hour TTL)
- Key: normalized `themes|tone|intentTags`
- "prayer" + "anxiety" + "hope" from different users hits same cache entry
- Common themes (prayer, faith, anxiety, identity) achieve 50-80% hit rates

### 4. Compressed System Prompts

- Devotional prompt: ~900 words down to ~500 words (44% reduction)
- Outline prompt: ~450 words down to ~280 words (38% reduction)
- All constraints preserved; redundant examples and formatting removed

### 5. Reduced Reference Chunks

- `calculateChunkCount()`: max reduced from 12 to 6
- Default 10-min day: 4 chunks instead of 6
- Chunk content truncated to 1200 chars (was unlimited up to ~6400)
- Top-scored chunks carry 80%+ of relevant material in their opening

## Future Optimizations (Not Yet Implemented)

### Tier 4: Batch Day Generation

- Generate Days 2-3 and Days 4-5 in paired calls (save 2 round-trips)
- Requires restructuring JSON output schema for multi-day responses
- Estimated additional savings: 10-15% on system prompt overhead

### Tier 5: Plan Template Library

- Pre-generate popular plan outlines offline for top 50 themes
- Serve from DB instead of LLM for ~90% of common inputs
- Estimated savings: outline call eliminated entirely for cached themes

### Tier 6: Progressive Quality

- Day 1 at full quality (first impression matters)
- Days 2-5 at reduced chunk count (user is committed by then)
- Estimated savings: additional 15-20% on day generation

## Quality Safeguards

- All LLM-generated days (1-5) still use full RAG pipeline
- Sabbath/Review deterministic builders were already the fallback path
- Outline cache only returns exact theme+tone matches
- All flags can be toggled per-environment for A/B testing

## Files Modified

| File                                            | Change                                                    |
| ----------------------------------------------- | --------------------------------------------------------- |
| `src/lib/brain/flags.ts`                        | 6 new token optimization flags                            |
| `src/lib/soul-audit/outline-cache.ts`           | New: LRU cache for outlines                               |
| `src/lib/soul-audit/generative-builder.ts`      | Exported fallbacks, compressed prompts, reduced chunks    |
| `src/lib/soul-audit/outline-generator.ts`       | Compressed prompt, reduced output tokens, truncated seeds |
| `src/app/api/soul-audit/submit/route.ts`        | Cache integration, flag-gated intent/reranking            |
| `src/app/api/soul-audit/generate-next/route.ts` | Flag-gated deterministic sabbath/review                   |

---

## Outcomes Log

- 2026-02-24: F-054 implemented. 6 optimizations across 3 tiers. 32% cost reduction per plan, 47-63% capacity increase at $100/month budget. All changes flag-gated for premium toggling.
