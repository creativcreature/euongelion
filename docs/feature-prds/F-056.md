# F-056: Fix Soul Audit Generation Pipeline

**Status:** Implemented
**Priority:** Critical (Soul Audit produces no devotional content)

---

## Problem

Soul Audit submit endpoint returned `OPTION_ASSEMBLY_FAILED` for every request. No AI-generated devotional outlines were being produced despite valid API keys being configured.

## Root Causes

Three cascading issues:

1. **Invalid Anthropic model name**: Default `claude-3-5-sonnet-latest` returns 404 from the Anthropic API (model retired/renamed).

2. **Empty env var shadowing**: dotenv v17 does not overwrite existing environment variables. When shell exports `ANTHROPIC_API_KEY=""` (empty string), the `.env.local` value is ignored. The `||` fallback in `providerCredentials()` treated empty string as truthy, so the provider appeared available but had no usable key.

3. **Truncated JSON from LLM**: `maxOutputTokens: 2400` was insufficient for 3 outlines x 7 days of structured JSON (~4000-6000 tokens). The LLM output was cut mid-JSON, causing `JSON.parse()` to fail silently (returning null).

## Fix

1. **Model name**: Changed default from `claude-3-5-sonnet-latest` to `claude-sonnet-4-6` (current valid Anthropic model ID).

2. **Env var resolution**: Created `firstNonEmptyEnv()` helper that explicitly trims and checks for non-empty values. Added `GEMINI_API_KEY` as fallback for Google provider.

3. **Token limit + JSON salvaging**: Increased `maxOutputTokens` to 8192. Added `tryParseJsonArray()` with `findLastCompleteObjectEnd()` to salvage complete outlines from truncated JSON responses.

4. **Diagnostic logging**: Added `console.info`/`console.warn`/`console.error` throughout the generation pipeline so failures are visible in server logs.

## Post-Audit Hardening (2026-02-26)

5 additional issues found and fixed during validation audit:

1. **Security**: Session fingerprint comparison in `clarifier.ts` was not timing-safe (plain `!==` on hex strings). Changed to `timingSafeEqual`.
2. **Bug**: Client-side timeout (15s) was too short for real LLM generation (30-60s). Every request falsely timed out. Increased to 90s.
3. **Error semantics**: `generatePlanOutlines()` swallowed provider errors as `null`, causing the submit route to return 422 instead of 503. Provider errors now rethrow.
4. **Redundant work**: `sanitizeOptionSet()` was called twice on the same data. Removed the first call.
5. **Lockfile sync**: `package-lock.json` engines field didn't match `package.json`.

## Files Changed

- `src/lib/brain/router.ts` — Model name fix, `firstNonEmptyEnv()`, `GEMINI_API_KEY` fallback
- `src/lib/soul-audit/outline-generator.ts` — Token limit, JSON salvaging, diagnostic logging, error propagation
- `src/lib/soul-audit/clarifier.ts` — Timing-safe session fingerprint comparison
- `src/lib/soul-audit/submit-client.ts` — Client timeout 15s → 90s
- `src/app/api/soul-audit/submit/route.ts` — Removed redundant double-sanitize

## Outcome

- Soul Audit submit returns 3 AI-generated plan outlines + 2 curated prefabs
- Truncated LLM output is automatically salvaged when possible
- All generation failures are logged with actionable details

## Acceptance Criteria

### Functional

- Submit with valid input returns 5 options (3 AI generative + 2 curated prefab)
- Each AI option includes a 7-day plan outline with scripture references
- Truncated JSON (e.g., from token limit) salvages at least 1 complete outline

### Operational

- Server logs show provider availability, LLM response stats, and parse results
- Generation failures include error type and first 300 chars of response
