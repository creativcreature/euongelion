# F-057: Fix RAG Pipeline — Deploy Real Reference Library Index

**Status:** Implemented
**Priority:** Critical (devotionals had zero real theological reference grounding)

---

## Problem

The 80/20 RAG composition contract requires 80% content from the reference library (commentaries, lexicons, theology) and 20% LLM-generated bridging. On production (Vercel), the devotionals had **0% real reference material** because:

1. `content/reference/` (13GB theological library) is gitignored — cannot deploy to Vercel
2. `public/reference-index.json` (pre-built index substitute) was **also gitignored** and **never created**
3. `reference-retriever.ts` silently fell back to indexing the app's own devotional JSONs as "reference material" — circular self-referencing
4. `reference-volumes.ts` returned empty arrays (no commentary witnesses available)
5. `generative-builder.ts` told the LLM "No reference library material available. Generate from theological knowledge" — pure hallucination dressed as curated content

## Root Cause

The reference-index.json entry in `.gitignore` (line 35) prevented the pre-built index from ever reaching production. The build script (`scripts/build-reference-index.ts`) existed but was never run, and even if it had been, its output would have been git-ignored.

Additionally, ~35 of 52 reference library .txt files contain **wrong Gutenberg downloads** (novels instead of theology). Only 9 files were verified correct.

## Fix

1. **Built `public/reference-index.json`** — 2,404 verified chunks (3.95 MB) from:
   - Augustine (City of God, Confessions)
   - Calvin (Institutes of the Christian Religion)
   - Luther (Commentary on Galatians)
   - Edwards (Selected Sermons)
   - Brother Lawrence (Practice of the Presence of God)
   - Thomas à Kempis (Imitation of Christ)
   - Tozer (The Pursuit of God)
   - Douglass (Narrative of the Life)
   - Verified Source Bank

2. **Removed gitignore block** — `public/reference-index.json` is now committed and deployed

3. **reference-retriever.ts** — Removed the devotional self-referencing fallback that created circular references on Vercel

4. **reference-volumes.ts** — Added fallback to load from `reference-index.json` when `content/reference/` is unavailable, so curated-builder gets real commentary witnesses

5. **generative-builder.ts** — Added `console.warn` when zero chunks retrieved; replaced silent "generate from knowledge" with explicit Scripture-grounding constraint

## Files Changed

- `public/reference-index.json` (new — 2,404 chunks, 3.95 MB)
- `.gitignore` (removed reference-index.json exclusion)
- `src/lib/soul-audit/reference-retriever.ts`
- `src/lib/soul-audit/reference-volumes.ts`
- `src/lib/soul-audit/generative-builder.ts`

## Verification

- TypeScript type-check passes
- Reference index readable and valid (2,404 chunks from 9 verified theological works)
- Production contracts check passes

## Known Issues (Follow-up)

- ~35 reference library files contain wrong Gutenberg downloads — need re-downloading
- Missing authors in index: Spurgeon, Wesley, Murray, Whitefield, Gill, Henry (all had wrong files)
- Lexicons (Strongs, Abbott-Smith) are XML format — not yet indexed
- Bible texts (KJV, ASV) not yet in index — only commentaries
