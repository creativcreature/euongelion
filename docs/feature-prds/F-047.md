# F-047: Billing: Entitlement checks

## Metadata

- Feature ID: F-047
- Category: Billing
- Owner: Engineering + Product + Release
- Status: in-progress
- Slug: billing-entitlement-checks

## Scores

- Baseline Score: 3/10
- Engineering Score: 7/10
- Founder Score: 0/10
- Founder 10/10 Rule: only founder can assign 10/10

## User Expectation

- Entitlement checks

## 10/10 Definition

- Behavior is reliable, predictable, and validated on desktop and mobile.
- Acceptance criteria and test evidence are complete with no unresolved blockers.

## Methodology References

- M00
- M05

## Device Contracts

### Desktop

- Primary interaction path is discoverable in one clear route.
- Error and recovery states are visible and actionable.

### Mobile

- Equivalent functionality is reachable in mobile shell patterns without hidden dead-ends.
- Touch targets and readability remain usable at 375/390 widths.

## Scope

### In scope

- Feature behavior and UX quality for: Entitlement checks
- Tracking and regression prevention for this feature

### Out of scope

- Unrelated feature changes not mapped to F-047

## Interfaces Touched

- `src/lib/billing/entitlements.ts`
- `src/lib/billing/lifecycle.ts`
- `src/app/api/billing/entitlements/route.ts`
- `src/app/api/billing/lifecycle/route.ts`
- `src/types/billing.ts`
- `__tests__/billing-entitlements.test.ts`
- `__tests__/billing-entitlements-api.test.ts`
- `__tests__/billing-lifecycle.test.ts`

## Dependencies

- F-038
- F-039

## Acceptance Criteria

- [x] Behavior definition updated and reviewed
- [x] Desktop and mobile contracts implemented
- [x] Automated tests updated where applicable
- [ ] Manual QA evidence recorded
- [x] Changelog updated

## Test Matrix

- [x] Automated: type-check, contracts, tracking, lint, test
- [ ] Manual desktop checks
- [ ] Manual mobile checks
- [ ] Accessibility and reduced-motion checks

## Risks and Rollback

- Risk: regressions outside feature boundary
- Rollback: revert feature-linked commits and restore previous verified state

## Incremental Outcomes Log

| Date       | Commit  | Decision IDs   | Feature ID | Change Summary                                                                                                                                                                                                                                                                                   | Verification                             | Score Delta | Residual Gaps                                                                                  |
| ---------- | ------- | -------------- | ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------- | ----------- | ---------------------------------------------------------------------------------------------- |
| 2026-02-15 | pending | SA-013, SA-014 | F-047      | Added canonical entitlement resolver and server endpoint (`GET /api/billing/entitlements`) that normalizes subscription tier and purchase-owned theme/sticker access into feature flags. Added request-id/error-rate-limit protections and regression tests for resolver + API output contracts. | `lint`, `type-check`, `test`, `verify:*` | 3 -> 6.6    | Still needs live Stripe/RevenueCat webhook integration to persist real purchased entitlements. |
| 2026-02-18 | pending | SA-013, SA-014 | F-047      | Added checkout-session lifecycle resolver + API (`GET /api/billing/lifecycle`) so entitlement checks can verify premium activation from live Stripe checkout/subscription states instead of query-param-only flash assumptions.                                                                  | `lint`, `type-check`, `test`, `verify:*` | 6.6 -> 7.0  | Needs signed webhook ingestion for asynchronous post-checkout updates.                         |

## Next Increment

- [ ] Bind entitlement snapshot to persisted purchase records/webhook pipeline
- [ ] Enforce entitlement checks at premium feature entry points in UI routes
