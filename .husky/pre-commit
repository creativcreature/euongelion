STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)
if [ -z "$STAGED_FILES" ]; then
  echo "No staged files. Skipping pre-commit checks."
  exit 0
fi

LINT_STAGED_MATCHES=$(echo "$STAGED_FILES" | grep -E '^(src/.+\.(ts|tsx)|__tests__/.+\.(ts|tsx)|.+\.(css|json|md))$' || true)
if [ -n "$LINT_STAGED_MATCHES" ]; then
  npx lint-staged
else
  echo "No lint-staged matching files. Skipping lint-staged."
fi

npm run type-check
npm run verify:production-contracts
npm run verify:tracking

# Enforce CHANGELOG update when code files change
CODE_CHANGED=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx)$' | head -1)
CHANGELOG_STAGED=$(git diff --cached --name-only | grep -c 'CHANGELOG.md' || true)

if [ -n "$CODE_CHANGED" ] && [ "$CHANGELOG_STAGED" -eq 0 ]; then
  echo ""
  echo "⚠️  CHANGELOG.md not staged but code files changed."
  echo "   Update CHANGELOG.md before committing."
  echo "   Bypass with --no-verify (emergencies only)."
  echo ""
  exit 1
fi
